{% extends 'base.html.twig' %}

{% block title %}Mi perfil{% endblock %}

{% block body %}
<div class="container mt-5">
    <div class="row">
        <!-- Columna izquierda: Perfil -->
        <div class="col-md-4" style="border-right: 1px solid #ddd; padding-right: 20px;text-align: right;">
            <h2>Bienvenido, {{ user.email }}</h2>

            <h4 class="mt-4">Tus API keys</h4>

            {% if user.apiKeys is not empty %}
                <ul class="list-group">
                    {% for key in user.apiKeys %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <code>{{ key.token }}</code>
                            {% if key.active %}
                                <span class="badge bg-success">activa</span>
                            {% else %}
                                <span class="badge bg-secondary">inactiva</span>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">Aún no tienes API keys.</p>
            {% endif %}

            <form method="post" action="{{ path('user_generate_apikey') }}" class="mt-3">
                <button class="btn btn-outline-primary">+ Generar nueva API key</button>
            </form>

            {% for message in app.flashes('success') %}
                <div class="alert alert-success mt-3">{{ message }}</div>
            {% endfor %}

            <hr>
            <h3>Llamada a la API</h3>
            <p>Usa la siguiente URL para subir imágenes vía API:</p>
            <pre class="bg-light p-2 rounded">POST {{ absolute_url(path('api_ocr')) }}</pre>
            <p>Parámetros:</p>
            <ul>
                <li><code>image_base64</code>: Imagen codificada en base64 (obligatorio)</li>
                <li><code>custom_id</code>: Identificador personalizado (opcional)</li>
            </ul>
            <p>Autenticación: Usa tu API key en el encabezado <code>Authorization: ApiKey &lt;API_KEY&gt;</code></p>
            <p>Respuesta: JSON con el estado del OCR y los datos extraídos.</p>
            <p>Ejemplo de respuesta:</p>
            <pre class="bg-light p-2 rounded" style="font-size: 0.85em; text-align: left;">
            {
                "id": 33,
                "filename": "ocr_68a81eb93be53.jpeg",
                "custom_id": "doc_test_ocr_data",
                "status": "completed",
                "created_at": "2025-08-22 09:39:37",
                "data": {
                    "company": "PARKING SOL DE LAS MORERAS",
                    "CIF": "B09013335",
                    "date": "2025-06-23",
                    "total": 3.4,
                    "concept": "RECIBO JUSTIFICANTE DE PAGO"
                },
                "user": "iosulazcano@gmail.com"
            }
            </pre>
            <hr>
            <p>
                <form method="post" action="{{ path('app_logout') }}">
                    <button type="submit" class="btn btn-outline-danger mt-3">Cerrar sesión</button>
                </form>
            </p>
        </div>

        <!-- Columna derecha: Subida de imagen + OCRs -->
        <div class="col-md-8">
            <h4>Subir nuevo gasto</h4>
            <form method="post" action="{{ path('gasto_subir') }}" enctype="multipart/form-data" class="mb-4">
                <div class="mb-3">
                    <label for="image" class="form-label">Imagen</label>
                    <input type="file" name="image" id="image" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="custom_id" class="form-label">Custom ID (opcional)</label>
                    <input type="text" name="custom_id" id="custom_id" class="form-control">
                </div>
                <button type="submit" class="btn btn-primary">Subir gasto</button>
            </form>

            <h5>Gastos subidos</h5>
            {% if ocrRequests is not empty %}
                <ul class="list-group">
                    {% for req in ocrRequests %}
                        <li class="list-group-item">
                            <div class="d-flex">
                                <!-- Imagen a la izquierda -->
                                <div class="me-3" style="width: 120px;">
                                    <img src="{{ asset('uploads/' ~ req.filename) }}"
                                        alt="Imagen del gasto"
                                        class="img-fluid rounded"
                                        style="height: 100%; object-fit: cover;">
                                </div>

                                <!-- Info a la derecha -->
                                <div class="flex-grow-1">
                                    <strong>{{ req.customId ?: 'Sin nombre' }}</strong> —
                                    <small>{{ req.createdAt|date('Y-m-d H:i') }}</small>
                                    <br>
                                    <span class="badge 
                                        {% if req.status == 'completed' %}bg-success
                                        {% elseif req.status == 'error' %}bg-danger
                                        {% else %}bg-secondary
                                        {% endif %}">
                                        {{ req.status }}
                                    </span>
                                    <br>
                                    <small class="text-muted">{{ req.filename }}</small>

                                    {% if req.result %}
                                        <pre class="mt-2 mb-0 bg-light p-2 rounded small">{{ req.result }}</pre>
                                    {% endif %}
                                </div>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">Aún no has subido ningún gasto.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
